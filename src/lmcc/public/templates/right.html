<!DOCTYPE html>
<html>
<head>
    <title>JARVIS LMCC | Right</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/right.css">
</head>
<body>
    <div id="panel_geo" class="panel">
        <div class="paneltitle">
            Geo Info
        </div>

        <button id="button_geopincreate" onclick="javascript:requestGeoPinCreation()">
            Create Geo Pin
        </button>

		<button id="button_togglebreadcrumbs" class="toggle-button" onclick="javascript:toggleBreadcrumbs()">
			Toggle Bread Crumbs
		</button>
		

        <input type="number" id="pinX" placeholder="X coordinate">
        <input type="number" id="pinY" placeholder="Y coordinate">
        <input type="text" id="pindesc" placeholder="Description...">
    	<div id="custom_pin_panel">
    		<ul id="geo_pin_list"></ul>
    	</div>

    	<div id="breadcrumb_panel">
            <ul id="breadcrumb_list"></ul>
        </div>
    </div>

    <button id="button_task_toggle" onclick="toggleTaskState()">
        Task: Not Started
    </button>

</body>
<script>
    var LOCAL_DATA = {}
    LOCAL_DATA["GEOPINS"] = [];

    var geo_pin_list = document.getElementById("geo_pin_list")

    // we need to keep this port value fixed, I guess
    const ws = new WebSocket('ws://' + "0.0.0.0" + ':' + "4761");

    function requestGeoPinCreation() {
        const x = document.getElementById('pinX').value;
        const y = document.getElementById('pinY').value;
        const desc = document.getElementById('pindesc').value;
    
        const geopinData = {
            content: {
                coords: { x: x || undefined, y: y || undefined },
            }, // Will be ignored if undefined
            desc: desc,
            sender: "LMCC", // Automatically set; adjust if needed for HMD
            type: "GEOPIN",
            timestamp: new Date().toISOString()
        };

        console.log(geopinData)
    
        // Use fetch to send data
        fetch('/geopins', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(geopinData)
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to create geopin');
            // return response.json(); // Or handle the response appropriately
        })
        .then(data => console.log('Geopin created:', data))
        .catch(error => console.error('Error creating geopin:', error));
    }
    

	var breadcrumbList = document.getElementById("breadcrumb_list");
	var breadcrumbsVisible = false;

	function toggleBreadcrumbs() {
		breadcrumbsVisible = !breadcrumbsVisible;
		var toggleButton = document.getElementById("button_togglebreadcrumbs");
	
		if (breadcrumbsVisible) {
			fetch('/breadcrumbs')
				.then(response => response.json())
				.then(breadcrumbs => {
					breadcrumbList.innerHTML = '';
					breadcrumbs.forEach(breadcrumb => {
						var li = document.createElement('li');
						var coords = breadcrumb.coords;
						var desc = breadcrumb.desc;
						li.textContent = `${desc}: (${coords.x.toFixed(2)}, ${coords.y.toFixed(2)})`;
						breadcrumbList.appendChild(li);
					});
					toggleButton.classList.add("active");
				})
				.catch(error => console.error('Error fetching breadcrumbs:', error));
		} else {
			breadcrumbList.innerHTML = '';
			toggleButton.classList.remove("active");
		}
	}
	
	


    function addGeoPin(content) {
        LOCAL_DATA["GEOPINS"].push(content)

        var li = document.createElement('li');

        var EVA1_x = Math.round(Number(content["coords"]["x"]) * 100) / 100
        var EVA1_y = Math.round(Number(content["coords"]["y"]) * 100) / 100

        li.appendChild(document.createTextNode(content["desc"]));
        li.appendChild(document.createElement("br"))
        li.appendChild(document.createTextNode("-: (" + EVA1_x + ", " + EVA1_y + ")"))

        geo_pin_list.appendChild(li)
    }
    function toggleTaskState() {
        // Get the button element
        var button = document.getElementById('button_task_toggle');

        // Check the current state
        if (button.innerText === 'Task: Not Started') {
            button.innerText = 'Task: Ongoing';
            button.classList.remove('not-started'); // Remove not-started class
            button.classList.add('ongoing'); // Add ongoing class
        } else if (button.innerText === 'Task: Ongoing') {
            button.innerText = 'Task: Completed';
            button.classList.remove('ongoing'); // Remove ongoing class
            button.classList.add('completed'); // Add completed class
        } else {
            button.innerText = 'Task: Not Started';
            button.classList.remove('completed'); // Remove completed class
            button.classList.add('not-started'); // Add not-started class
        }

        // make function call 
    }

	ws.onmessage = async function (event, isBinary) {
		var data = await event.data.text();
		var message = JSON.parse(data);
		var message_type = message["type"];
		console.log('Received ' + message_type + ' from ' + message["sender"]);
	
		if (message_type == "GEOPIN") {
			console.log(message["content"]);
			addGeoPin(message["content"]);
		} else if (message_type == "BREADCRUMBS") {
			// Display the list of breadcrumbs
			breadcrumbList.innerHTML = '';
			message.content.forEach(breadcrumb => {
				var li = document.createElement('li');
				var coords = breadcrumb.content.coords;
				var desc = breadcrumb.desc;
				li.textContent = `${desc}: (${coords.x.toFixed(2)}, ${coords.y.toFixed(2)})`;
				breadcrumbList.appendChild(li);
			});
		}
	};
	

    // when we load, check with the server for existing pins
    fetch('/localdata/GEOPINS')
    .then(response => {
        if (!response.ok) throw new Error('Failed to load existing geopins');
        return response.json();
    })
    .then(data => {
        for (let pin_num of Object.keys(data)) {
            addGeoPin(data[pin_num]);
        }
    })
    .catch(error => console.error('Error loading existing geopins:', error));

</script>
</html>
